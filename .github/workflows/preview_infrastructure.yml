name: Pulumi preview

on:
    - pull_request

jobs:
    preview:
        name: Preview Pulumi Projects
        runs-on: ubuntu-latest
        strategy:
            matrix:
                project:
                        - backend/infrastructure/stack/networking
                        - backend/infrastructure/stack/container-repository
                        - backend/infrastructure/stack/application-base
                        - backend/infrastructure/stack/queues
                        - backend/infrastructure/stack/secrets
                        - backend/infrastructure/stack/main-backend-image
                        - backend/infrastructure/stack/inference-backend-image
                        - backend/infrastructure/stack/queue-handler-image
        steps:
        - name: "Checkout repository"
          uses: actions/checkout@v2

        - name: "Set up Go"
          uses: actions/setup-go@v3
          with:
            go-version: 'stable'

        - name: "Configure AWS Credentials"
          uses: aws-actions/configure-aws-credentials@v1
          with:
            aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
            aws-region: ${{ secrets.AWS_REGION }}
            aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

        - name: "Install dependencies"
          run: |
            cd ${{ matrix.project }}
            go mod download
            
        - name: "Run Pulumi Preview"
          uses: pulumi/actions@v3
          with:
            command: preview
            stack-name: dev
          env:    
            PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
